{% comment %}
  Process API response and set up variables for templates
{% endcomment %}

{% assign using_sample = false %}
{% assign debug_mode = false %}

{% comment %}The API response data is available at the top level{% endcomment %}

{% comment %}DEBUG INFO - Only shown when debug mode is enabled{% endcomment %}
{% if debug_mode %}
<div class="debug-panel" style="border: 2px dashed #c00; padding: 10px; margin: 10px; background: #fff; font-family: monospace; font-size: 12px;">
  <h3>NYT API Debug Info:</h3>
  <pre>
status: {{ status | json }}
copyright: {{ copyright | json }}
num_results: {{ num_results | json }}
results structure available: {% if results %}Yes{% else %}No{% endif %}
books count: {% if books %}{{ books.size }}{% else %}0{% endif %}
  </pre>
</div>
{% endif %}

{% if results != blank %}
  {% assign list = results.display_name | default: results.list_name %}
  {% assign list_date = results.published_date | default: results.last_modified %}
  {% assign books = results.books %}

  {% comment %}Save complete API response for debugging{% endcomment %}
  {% assign api_response = results | json %}
{% else %}
  {% comment %}If no API data is available, use sample data{% endcomment %}
  {% assign list = "Hardcover Fiction" %}
  {% assign list_date = "now" | date: "%Y-%m-%d" %}
  {% assign using_sample = true %}
{% endif %}

{% comment %}Get display settings from trmnl object{% endcomment %}
{% if trmnl != blank %}
  {% assign display = trmnl.plugin_settings.custom_fields_values.nyt_display | default: "covers" %}
  {% assign display_count = trmnl.plugin_settings.custom_fields_values.display_count | default: "10" | plus: 0 %}
  {% assign show_debug = trmnl.plugin_settings.custom_fields_values.show_debug | default: "no" %}
  {% if show_debug == "yes" %}
    {% assign debug_mode = true %}
  {% endif %}
{% else %}
  {% assign display = "covers" %}
  {% assign display_count = 10 %}
  {% assign show_debug = "no" %}
{% endif %}

{% comment %}Handle error cases{% endcomment %}
{% if books == blank %}
  {% assign has_error = true %}
  {% assign error_message = "No books data available. API response format may be unexpected or the API key may be invalid." %}

  {% if debug_mode %}
  <div style="border: 1px solid #ccc; padding: 10px; margin: 10px; background: #f0f0f0;">
    <h3>Debug Data:</h3>
    <p>API Status: {{ status }}</p>
    <p>Has Results Object: {% if results %}Yes{% else %}No{% endif %}</p>
    <p>Results JSON: {{ results | json }}</p>
  </div>
  {% endif %}
{% else %}
  {% assign has_error = false %}
  {% assign error_message = "" %}
{% endif %}

<style>
  .trmnl .clamp--nicely {
    word-break: break-word;
  }
  .book-cover {
    height: auto;
    object-fit: cover;
    filter: grayscale(1) contrast(1.2) brightness(1.1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .book-rank {
    position: absolute;
    bottom: 2px;
    right: 2px;
    border: solid 2px #ffffff;
    padding: 0 4px;
    font-size: 0.8em;
    font-weight: bold;
    background-color: black;
    color: white;
  }
  .error-message {
    padding: 1em;
    border: 1px solid #888;
    text-align: center;
    margin: 1em;
  }

  .debug-panel {
    position: relative;
    z-index: 9999;
    max-height: 300px;
    overflow: auto;
  }
  .debug-data {
    margin-bottom: 5px;
    padding: 5px;
    border-bottom: 1px solid #ddd;
  }
  .debug-key {
    font-weight: bold;
    color: #555;
  }
  .debug-value {
    font-family: monospace;
    word-break: break-all;
  }
</style>

{%- capture nyt_svg %}
<svg xmlns="http://www.w3.org/2000/svg" width="139" height="186" viewBox="0 0 13.9 18.6">
  <path d="M13.9,2.5C13.9.5,12,0,10.5,0V.3c.9,0,1.6.3,1.6,1a1.05872,1.05872,0,0,1-1.2,1,12.95853,12.95853,0,0,1-3.3-.8A13.27527,13.27527,0,0,0,4.1.7,3.27043,3.27043,0,0,0,.7,3.9,2.31777,2.31777,0,0,0,2.2,6.1l.1-.2a1.05381,1.05381,0,0,1-.6-1A1.26593,1.26593,0,0,1,3.1,3.8a14.776,14.776,0,0,1,3.7.9,28.25773,28.25773,0,0,0,3.7,.8V8.6L9,9.9V10l1.5,1.3v4.3a4.6179,4.6179,0,0,1-2.5,.6,4.92913,4.92913,0,0,1-3.9-1.6l4.1-2v-7l-5,2.2A6.68515,6.68515,0,0,1,5.8,4.9l-.1-.2A7.47133,7.47133,0,0,0,0,11.6a7.01948,7.01948,0,0,0,7,7,6.50532,6.50532,0,0,0,6.6-6.5h-.2a6.69748,6.69748,0,0,1-2.6,3.1V11.1l1.6-1.3V9.7L10.9,8.4v-3A2.85791,2.85791,0,0,0,13.9,2.5Zm-8.7,11L4,14.1a5.93247,5.93247,0,0,1-1.1-3.8,7.10647,7.10647,0,0,1,.3-2.1l2.1-.9Z"/>
</svg>
{% endcapture %}
