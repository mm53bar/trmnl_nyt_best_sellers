#!/usr/bin/env bash
set -e

# Make sure .env file exists
if [ ! -f .env ]; then
  if [ -f .env.example ]; then
    echo "Creating .env from .env.example"
    cp .env.example .env
    echo "IMPORTANT: Update your .env file with your actual API key"
  else
    echo "ERROR: No .env file found and no .env.example to copy from"
    exit 1
  fi
fi

# Check if Ruby is installed
if ! command -v ruby &> /dev/null; then
  echo "ERROR: Ruby is not installed"
  echo "Please install Ruby 3.4.0 or later"
  exit 1
fi

# Check if bundler is installed
if ! command -v bundle &> /dev/null; then
  echo "Installing bundler..."
  gem install bundler
fi

# Install dependencies if they're not already installed
if [ ! -d "vendor/bundle" ]; then
  echo "Installing dependencies..."
  bundle config set --local path 'vendor/bundle'
  bundle install
fi

echo "Starting TRMNL preview server..."
bundle exec dotenv bundle exec trmnlp serve
