#!/usr/bin/env bash
set -e

# Usage information
if [ $# -lt 1 ] || [[ ! "$1" =~ ^(major|minor|patch)$ ]]; then
  echo "Usage: $0 [major|minor|patch] [options]"
  echo "Example: $0 patch"
  echo ""
  echo "Options:"
  echo "  --push    Automatically push changes without confirmation"
  exit 1
fi

# Read current version
VERSION_FILE="VERSION"
if [ ! -f "$VERSION_FILE" ]; then
  echo "ERROR: $VERSION_FILE not found"
  exit 1
fi

CURRENT_VERSION=$(cat "$VERSION_FILE")

# Split version into components
IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
MAJOR=${VERSION_PARTS[0]}
MINOR=${VERSION_PARTS[1]}
PATCH=${VERSION_PARTS[2]}

# Bump version based on argument
case "$1" in
  major)
    MAJOR=$((MAJOR + 1))
    MINOR=0
    PATCH=0
    ;;
  minor)
    MINOR=$((MINOR + 1))
    PATCH=0
    ;;
  patch)
    PATCH=$((PATCH + 1))
    ;;
esac

# Create new version string
NEW_VERSION="$MAJOR.$MINOR.$PATCH"

# Update VERSION file
echo "$NEW_VERSION" > "$VERSION_FILE"

# Update version in settings.yml
SETTINGS_FILE="src/settings.yml"
if [ -f "$SETTINGS_FILE" ]; then
  # Use different sed syntax based on OS
  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sed -i '' "s/version: .*$/version: $NEW_VERSION/" "$SETTINGS_FILE"
  else
    # Linux and others
    sed -i "s/version: .*$/version: $NEW_VERSION/" "$SETTINGS_FILE"
  fi
  echo "Updated version in $SETTINGS_FILE"
fi

# Commit changes
git add "$VERSION_FILE"
if [ -f "$SETTINGS_FILE" ]; then
  git add "$SETTINGS_FILE"
fi
git commit -m "Bump version to v$NEW_VERSION"

# Create tag
git tag "v$NEW_VERSION"

echo "Version bumped from $CURRENT_VERSION to $NEW_VERSION"
echo "Changes committed and tag v$NEW_VERSION created"
echo ""

# Check for --push flag
if [[ "$*" == *"--push"* ]]; then
  SKIP_CONFIRM=true
else
  SKIP_CONFIRM=false
fi

# Ask for confirmation before pushing
if [ "$SKIP_CONFIRM" = false ]; then
  read -p "Push changes and trigger release now? (y/n) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Push skipped. To complete the release process manually:"
    echo "git push origin main && git push origin v$NEW_VERSION"
    exit 0
  fi
fi

# Push changes and tag
echo "Pushing changes to remote..."
if git push origin main && git push origin "v$NEW_VERSION"; then
  echo "✅ Push successful! GitHub Actions workflow will create a release."
else
  echo "❌ Push failed. Please push manually:"
  echo "git push origin main && git push origin v$NEW_VERSION"
  exit 1
fi
